#!/bin/bash

if [[ -z $1 ]]; then
    echo 'Usage: install_on_remote <repo-path> <host> [<rsync-remote-shell>]'
    exit 1
fi

# set -o verbose
# set -o xtrace

REPO_PATH=$(realpath $1)
REPO_NAME=$(basename $REPO_PATH)
HOST=$2
SSH=${3:-ssh}
RSYNC="rsync --exclude=.gitignore --exclude=.git --exclude=build -a --delete"

if [[ ! -x "$REPO_PATH/bin/$(basename $0)" ]]; then
    echo 'Bad repo path.'
    exit 1
fi

if [[ -z "$HOST" ]]; then
    echo 'Bad host.'
    exit 1
fi

$RSYNC -e "$SSH" $REPO_PATH $HOST:~

$SSH $HOST '
cd ~/'"$REPO_NAME"' && \
make && make install && \
./bin/install_vim_plug && \
./bin/install_vim_plug_plugins
'
